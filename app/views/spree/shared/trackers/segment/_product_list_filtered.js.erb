<% if params[:search].present? && Spree::Tracker.current(:segment) %>
  <script>
    if (typeof analytics !== 'undefined') {
      var segmentProductListFilteredJson = {
        filters: [
          <% params[:search].to_unsafe_h.each do |type, value| %>
            <%= { type: type, value: value } .to_json.html_safe %>,
          <% end %>
        ],
        products: [
        <% @products.each_with_index do |product, index| %>
          <%= product_for_segment(product, position: index+1) %>,
        <% end %>
        ]
      }

      analytics.track('Product List Filtered', segmentProductListJson);
      analytics.page('Product List Filtered', segmentProductListJson);
    }
  </script>
<% end %>
